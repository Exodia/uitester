/**
 * UITester Client Manager Module
 * @author: LongGang <tblonggang@gmail.com>
 */

var  EventManager = require('event-mgr').EventManager;

var ClientPool = {
    init:function () {
        this.summary = { total:0 };

        // store all clients referrence while the client
        // type is not cared
        this.clients = {};

        // store clients referrence by client type
        this.clientsMap = {};

        this.freeClients = {};
    },


    /*
    * 获取浏览器类型
    * */
    getTypes: function() {
      return Object.keys(this.clientsMap);
    },

    getInfo:function () {
        return this.summary;
    },

    _updateInfo:function (clientObject, action) {
        var host = this,
            clientType = clientObject.clientType,
            summary = host.summary;

        if ('add' === action) {
            summary[clientType] || ( summary[clientType] = 0)
            summary[clientType]++;
            summary.total++;
        }

        if ('remove' === action) {
            summary[clientType]--;
            summary.total--;
        }

//        console.info('[ClientPool Message]', clientType, action);
//        console.info(host.summary);
//        console.info(host.clientsMap);
    },

    _getUA:function (uaObj) {
        return (uaObj.name + (uaObj.msie ? uaObj.version : ''));
    },

    setItem:function (clientObject) {
        var host = this,
            id = clientObject.id;

        var clientType = host._getUA(clientObject.userAgent.browser);
        clientObject.clientType = clientType;
        host.clientsMap[clientType] || (host.clientsMap[clientType] = {});

        host.clients[id] = clientObject;
        host.clientsMap[clientType][id] = clientObject;
        host.freeClients[id] = clientObject;

        host._updateInfo(clientObject, 'add');
    },

    removeItem:function (clientObject) {
        var id = clientObject.id,
            clientType = clientObject.clientType;

            delete  this.clients[id];
            delete  this.clientsMap[clientType][id];
            delete this.freeClients[id];

        this._updateInfo(clientObject, 'remove');
    }
};

var ClientManager = {
    listenEventMap:{
        'client:register':function (clientObject) {
            ClientPool.setItem(clientObject);
            EventManager.emit('client:available', clientObject);
        },

        // send a msg to client for trace log
        'client:available':function (clientObject) {
            console.info('[ClientMgr Event] available client:', clientObject.clientType);
            ClientPool.freeClients[clientObject.id] = clientObject;
            clientObject.socket.emit('console:available', {
                'msg':'UITester: An client is available.',
                'available_client':clientObject.clientType,
                'client_summary':ClientPool.getInfo()
            });
        },

        'client:disconnect':function (clientObject) {
            console.info('[ClientMgr Event] client disconnect', clientObject.clientType);
            ClientPool.removeItem(clientObject);
            EventManager.emit('client:unavailable', clientObject);
        },

        'client:task_finish':function (clientObject) {
            console.info('[ClientMgr Event] client task finish');

            var reportData = clientObject.reportData;

            EventManager.emit('client:task_finish', clientObject);
        },

        'task:data_update':function () {
            console.info('[TaskMgr Event] new data is OK');
            /*
            * 触发浏览器类型事件，同时丢入现有的浏览器类型
            * */
            EventManager.emit('client:types', ClientPool.getTypes(), ClientPool.freeClients);
         },

        'client:busy':function (id) {
            delete ClientPool.freeClients[id];
        }
    },

    init:function (config) {
        var host = this;

        ClientPool.init();

        host.handleEventListener();
    },

    handleEventListener:function () {
        var evmap = this.listenEventMap;
        for(var k in  evmap) {
            EventManager.on(k, evmap[k]);
        }
    }
};

module.exports = ClientManager;
