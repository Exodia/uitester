/**
 * Created with JetBrains WebStorm.
 * User: tafeng.dxx
 * Date: 12-11-24
 * Time: 下午3:45
 */

//导入模块
var EventManager = require('event-mgr').EventManager;
var db = require('db');

//数据获取周期
var INTERVAL = 5000,
//缓冲大小
    BUFFER_SIZE = 1;


/*用例队列*/
var TaskCache = {
        tasks:null,
        total:0
    },
/*报告缓冲区*/
    reportBuffer = [];

/**
 * 用例管理函数，负责取用例，插入用例测试结果
 * @type {Object}
 */
var TaskManager = {
    init:function () {
        this._bindEvents();
        this.fetchTask();
    },
    /*用例结束，插入数据库结果
     * 每满50个才进行一次性的插入，防止频繁的操作数据库
     */
    report:function (task, info) {
        reportBuffer.push({task:task, info:info});
        //缓冲区未满，且任务队列未空
        if (reportBuffer.length < BUFFER_SIZE && TaskCache.total) {
            return;
        }

        db.insert(reportBuffer, function (err) {
            err && console.log(err);
            //清除报告缓冲区
            reportBuffer = [];
            //任务队列空，则取数据
            !TaskCache.total && TaskManager.fetchTask();
        });
    },
    fetchTask:function () {
        db.findLatestSpecs(function (data) {
            if (!data.length) {
                console.log('no data');
                return setTimeout(TaskManager.fetchTask, INTERVAL);
            }

            TaskCache.tasks = data;
            TaskCache.total = data.length;
            this.browserCache = {};
            EventManager.emit('task:data_update');
        });
    },
    browserCache:{},
    _eventsMap:{
        /*更新浏览器用例队列*/
        'client:types':function (types, clients) {
            console.log('client:types:', TaskCache);
            var i, len = types.length, tasks = TaskCache.tasks;
            //对每种浏览器复制一份用例引用
            for (i = len - 1; i > -1; --i) {
                TaskManager.browserCache[types[i]] = TaskCache.tasks.slice(0);
            }
            //对每个用例，将计数器至为浏览器类型数量
            for (i = 0, len =  TaskCache.length; i < len; ++i) {
                tasks[i].browserCount = tasks[i].total_specs = len;
            }
        },

        /*浏览器空闲事件，触发task事件，同时丢入一个task*/
        'client:available':function (clientObject) {
            var tasks = TaskManager.browserCache[clientObject.clientType];
            if (tasks && tasks.length) {
                clientObject.runTask(tasks.pop())
            }
        },

        /*用例测完*/
        'client:task_finish':function (task, info) {
            //用例测完，减少计数器
            if (--task.browserCount == 0) {
                //计数器为0，减少用例池的总数，同时报告该用例结果
                --taskCache.total;
                TaskManager.report(task, info);
            }
        }
    },
    //事件绑定
    _bindEvents:function () {
        var evts = this._eventsMap;
        for (var k in evts) {
            EventManager.on(k, evts[k]);
        }
    }
};

exports.TaskManager = TaskManager;